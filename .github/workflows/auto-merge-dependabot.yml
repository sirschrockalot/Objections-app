# Auto-merge Dependabot PRs that pass CI
# Only merges patch/minor updates to reduce risk

name: Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Check if PR is safe to auto-merge
        id: check
        run: |
          # Only auto-merge if:
          # 1. PR is from Dependabot
          # 2. PR has "dependencies" label
          # 3. PR title doesn't contain "major" or "breaking"
          
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_LABELS="${{ github.event.pull_request.labels.*.name }}"
          
          if [[ "$PR_TITLE" == *"major"* ]] || [[ "$PR_TITLE" == *"breaking"* ]]; then
            echo "safe=false" >> $GITHUB_OUTPUT
            echo "Reason: Major version update detected"
            exit 0
          fi
          
          if [[ "$PR_LABELS" == *"dependencies"* ]]; then
            echo "safe=true" >> $GITHUB_OUTPUT
            echo "Reason: Safe to auto-merge"
          else
            echo "safe=false" >> $GITHUB_OUTPUT
            echo "Reason: Missing dependencies label"
          fi
      
      - name: Wait for CI to pass
        if: steps.check.outputs.safe == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            // Wait for required status checks to pass (max 15 minutes)
            const maxWait = 15 * 60 * 1000; // 15 minutes
            const startTime = Date.now();
            const requiredChecks = ['Tests']; // Add other required checks here
            
            while (Date.now() - startTime < maxWait) {
              // Check commit status
              const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha,
              });
              
              // Check workflow runs
              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: pr.head.sha,
                per_page: 10,
              });
              
              const allChecksPassed = 
                statuses.length > 0 && 
                statuses.every(status => status.state === 'success' || status.state === 'pending') &&
                runs.workflow_runs.every(run => 
                  run.status === 'completed' && run.conclusion === 'success' ||
                  run.status === 'in_progress' || run.status === 'queued'
                );
              
              const anyFailed = 
                statuses.some(status => status.state === 'failure') ||
                runs.workflow_runs.some(run => run.conclusion === 'failure');
              
              if (anyFailed) {
                console.log('❌ Some checks failed. Not auto-merging.');
                core.setFailed('CI checks failed');
                return;
              }
              
              if (allChecksPassed && runs.workflow_runs.every(run => run.status === 'completed')) {
                console.log('✅ All checks passed!');
                break;
              }
              
              console.log('⏳ Waiting for CI to pass...');
              await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30 seconds
            }
            
            if (Date.now() - startTime >= maxWait) {
              console.log('⏰ Timeout waiting for CI. Not auto-merging.');
              core.setFailed('Timeout waiting for CI');
            }
      
      - name: Auto-merge PR
        if: steps.check.outputs.safe == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
            });
            console.log('PR merged successfully!');

